<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Ubi Smashers | Badminton Cost Sharing</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
/* General layout & theme */
:root {
  --primary: #0f766e; /* Teal */
  --primary-dark: #0d635c;
  --primary-light: #e0f2f1; /* Light Teal */
  --bg: #f3f4f6; /* Light gray */
  --dark: #0f172a; /* Dark Blue */
  --muted: #6b7280; /* Gray */
  --error: #ef4444; /* Red */
  --success: #10b981; /* Green */
  --radius: 14px;
  --shadow: 0 8px 24px rgba(15, 23, 42, 0.12);
}

* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background: var(--bg);
  color: #111827;
  line-height: 1.5;
  padding: 20px;
}
a { color: inherit; text-decoration: none; }

header {
  position: sticky;
  top: 0;
  z-index: 20;
  backdrop-filter: blur(12px);
  background: rgba(243, 244, 246, 0.9);
  border-bottom: 1px solid rgba(148, 163, 184, 0.2);
  margin-bottom: 20px;
  padding: 10px 0;
}

.container {
  max-width: 1000px;
  margin: 0 auto;
}

h1 {
  font-size: 1.8rem;
  font-weight: 700;
  color: var(--dark);
}

/* Utility classes */
.card {
  background: white;
  border-radius: var(--radius);
  box-shadow: var(--shadow);
  padding: 20px;
  margin-bottom: 20px;
}

.flex-between {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

/* Buttons */
.btn {
  padding: 10px 20px;
  border-radius: 10px;
  font-weight: 600;
  cursor: pointer;
  transition: background-color 0.2s, transform 0.1s;
  border: none;
}

.btn-primary {
  background: var(--primary);
  color: white;
}

.btn-primary:hover {
  background: var(--primary-dark);
}

.btn-secondary {
  background: var(--bg);
  color: var(--dark);
  border: 1px solid var(--muted);
}

.btn-secondary:hover {
  background: #e5e7eb;
}

.btn:active {
  transform: scale(0.98);
}

.btn-sm {
  padding: 6px 12px;
  font-size: 0.875rem;
}

.btn-danger {
  background: var(--error);
  color: white;
}

/* Forms */
label {
  display: block;
  font-weight: 600;
  margin-bottom: 5px;
  color: var(--dark);
  font-size: 0.9rem;
}

input[type="date"], input[type="number"], .select-month {
  width: 100%;
  padding: 10px;
  margin-bottom: 15px;
  border: 1px solid #d1d5db;
  border-radius: 8px;
  font-size: 1rem;
}

/* Monthly Summary Table */
.monthly-summary h2 {
  font-size: 1.5rem;
  margin-bottom: 10px;
  color: var(--primary);
}

.table-container {
  overflow-x: auto;
}

.monthly-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 15px;
}

.monthly-table th, .monthly-table td {
  padding: 12px 15px;
  text-align: left;
  border-bottom: 1px solid #e5e7eb;
}

.monthly-table th {
  background-color: var(--primary-light);
  color: var(--primary);
  font-weight: 700;
  text-transform: uppercase;
  font-size: 0.8rem;
}

.monthly-table tr:hover {
  background-color: #f9fafb;
}

.total-row td {
  font-weight: 700;
  background-color: var(--primary-light);
  border-bottom: 3px solid var(--primary);
}

/* History */
.session-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 0;
  border-bottom: 1px solid #e5e7eb;
}

.session-item:last-child {
  border-bottom: none;
}

.session-details p {
  margin: 3px 0;
  font-size: 0.9rem;
}

.session-date {
  font-weight: 700;
  color: var(--primary);
  font-size: 1.1rem;
}

.session-cost {
  font-weight: 600;
  color: var(--dark);
}

.player-list {
  font-size: 0.8rem;
  color: var(--muted);
  font-style: italic;
}

.session-actions button {
  margin-left: 8px;
}

/* Modal Styling */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.6);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 50;
}

.modal-content {
  background: white;
  padding: 30px;
  border-radius: var(--radius);
  max-width: 90%;
  width: 500px;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: var(--shadow);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  border-bottom: 1px solid #e5e7eb;
  padding-bottom: 10px;
}

.modal-header h3 {
  font-size: 1.5rem;
  color: var(--dark);
}

.close-btn {
  background: none;
  border: none;
  font-size: 1.5rem;
  cursor: pointer;
  color: var(--muted);
}

.checklist-container {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 10px;
  margin-bottom: 20px;
}

.error-message {
  color: var(--error);
  font-weight: 600;
  margin-top: 10px;
  display: none;
}

.admin-info {
  margin-top: 20px;
  padding: 10px;
  background: var(--primary-light);
  border-radius: 8px;
  color: var(--primary);
  font-size: 0.9rem;
}

.admin-info span {
  font-weight: 700;
  word-break: break-all;
}

/* Status Message */
#status-message {
  color: var(--primary);
  font-weight: 600;
  margin-bottom: 15px;
  text-align: center;
}
  </style>
</head>
<body>

  <header>
    <div class="container flex-between">
      <div style="display: flex; align-items: center;">
        <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-feather" style="color: var(--primary); margin-right: 10px;"><path d="M20.24 12.24l-8.48 8.48-8.48-8.48 8.48-8.48 8.48 8.48zM15 15l-6-6"/></svg>
        <h1>Ubi Smashers</h1>
      </div>
      <button class="btn btn-primary" onclick="openAddModal()">Add Session</button>
    </div>
  </header>

  <main class="container">
    <div id="status-message">Loading data...</div>
    
    <section class="admin-info card">
      <p>Your unique User ID (for sharing/admin tasks): <span id="user-id"></span></p>
    </section>

    <section class="monthly-summary card">
      <div class="flex-between">
        <h2>Monthly Summary</h2>
        <select id="month-selector" class="select-month" onchange="updateMonthlyTable()" style="width: auto;">
          </select>
      </div>

      <div class="table-container">
        <table id="monthly-table" class="monthly-table">
          <thead>
            <tr>
              <th>Player</th>
              <th>Sessions Count</th>
              <th>Total Cost (S$)</th>
              <th>Average Cost (S$)</th>
            </tr>
          </thead>
          <tbody>
            </tbody>
        </table>
      </div>
    </section>

    <section class="history-list card">
      <h2>Session History (<span id="history-count">0</span>)</h2>
      <div id="sessions-history">
        </div>
    </section>

    <footer>
      <p style="text-align: center; color: var(--muted); font-size: 0.8rem; padding-top: 10px;">&copy; <span id="year"></span> Ubi Smashers. Data stored securely in Firestore.</p>
    </footer>
  </main>

  <div id="addModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Add New Session</h3>
        <button class="close-btn" onclick="closeAddModal()">&times;</button>
      </div>
      <form id="addForm">
        <label for="date">Date</label>
        <input type="date" id="date" required>

        <label for="courtCost">Court Cost (S$)</label>
        <input type="number" id="courtCost" step="0.01" value="30" required>

        <label for="shuttleCost">Shuttlecock Cost (S$)</label>
        <input type="number" id="shuttleCost" step="0.01" value="2.50" required>

        <label for="shuttlesUsed">Shuttlecocks Used (pcs)</label>
        <input type="number" id="shuttlesUsed" value="10" required>

        <label>Players Attended</label>
        <div id="playerChecklist" class="checklist-container">
          </div>

        <p id="add-err" class="error-message">Please fill all fields and select at least one player.</p>

        <button type="submit" class="btn btn-primary" style="width: 100%;">Save Session</button>
      </form>
    </div>
  </div>

  <div id="editModal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Edit Session</h3>
        <button class="close-btn" onclick="closeEditModal()">&times;</button>
      </div>
      <form id="editForm">
        <input type="hidden" id="editSessionId">

        <label for="editDate">Date</label>
        <input type="date" id="editDate" required>

        <label for="editCourtCost">Court Cost (S$)</label>
        <input type="number" id="editCourtCost" step="0.01" required>

        <label for="editShuttleCost">Shuttlecock Cost (S$)</label>
        <input type="number" id="editShuttleCost" step="0.01" required>

        <label for="editShuttlesUsed">Shuttlecocks Used (pcs)</label>
        <input type="number" id="editShuttlesUsed" required>

        <label>Players Attended</label>
        <div id="editPlayerChecklist" class="checklist-container">
          </div>

        <p id="edit-err" class="error-message">Please fill all fields and select at least one player.</p>

        <button type="button" class="btn btn-primary" style="width: 100%; margin-bottom: 10px;" onclick="saveEditedSession()">Save Changes</button>
        <button type="button" class="btn btn-danger" style="width: 100%;" onclick="deleteSessionFromEdit()">Delete Session</button>
      </form>
    </div>
  </div>

  <div id="confirmModal" class="modal-overlay" style="display: none;">
    <div class="modal-content" style="width: 350px;">
      <div class="modal-header" style="border-bottom: none; margin-bottom: 0;">
        <h3 id="confirm-title">Confirm Action</h3>
        <button class="close-btn" onclick="closeConfirmModal()">&times;</button>
      </div>
      <p id="confirm-message" style="margin-bottom: 20px;">Are you sure you want to proceed?</p>
      <div style="display: flex; justify-content: flex-end; gap: 10px;">
        <button class="btn btn-secondary" onclick="closeConfirmModal()">Cancel</button>
        <button id="confirm-action-btn" class="btn btn-danger">Confirm</button>
      </div>
    </div>
  </div>

  <script>
    // These functions must be defined globally for HTML inline onclick handlers to work.
    // They interact with the module's exported/global state.

    function requireAdmin() {
      // Admin check is omitted here as adding sessions is a standard user action
      // We still include it here for Edit/Delete functions to call
      const passcode = prompt("Enter Admin Passcode:");
      // Simple client-side check for demonstration purposes
      if (passcode === "admin123") {
        return true;
      }
      // Replaced alert with console error as per guidelines, or a custom modal if needed, 
      // but keeping prompt/alert pattern for simple admin gate
      console.error("Incorrect Admin Passcode.");
      return false;
    }

    function openAddModal() {
      document.getElementById("addForm").reset();
      document.getElementById("add-err").style.display = "none";
      // Access module function via window
      window.renderPlayerChecklist("playerChecklist");
      document.getElementById("addModal").style.display = "flex";
      // Set default date to today
      document.getElementById("date").value = new Date().toISOString().slice(0, 10);
    }

    function closeAddModal() {
      document.getElementById("addModal").style.display = "none";
    }

    function openEditModal(id) {
      // Access module function via window
      window.moduleOpenEditModal(id);
    }

    function closeEditModal() {
      document.getElementById("editModal").style.display = "none";
    }

    function closeConfirmModal() {
      document.getElementById("confirmModal").style.display = "none";
    }

    function confirmDeleteSession(id) {
        if (!requireAdmin()) return;
        // Access module function via window
        window.moduleConfirmDeleteSession(id);
    }
    
    function deleteSessionFromEdit() {
        // Access module function via window
        window.moduleDeleteSessionFromEdit();
    }
    
    function saveEditedSession() {
        // Access module function via window
        window.moduleSaveEditedSession();
    }
    
  </script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, getDoc, collection, getDocs, query, where, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Set logging level to debug for troubleshooting
    setLogLevel('Debug');


    // --- MANDATORY FIREBASE GLOBALS ---
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    // --- APP STATE & FIREBASE INSTANCES ---
    let sessions = [];
    const allPlayers = ["John", "Jane", "Alice", "Bob", "Charlie", "David", "Eve", "Frank"];
    let db = null;
    let auth = null;
    let userId = null;
    let isAuthReady = false;

    // --- UI/Modal References ---
    const addModal = document.getElementById("addModal");
    const editModal = document.getElementById("editModal");
    const confirmModal = document.getElementById("confirmModal");
    const confirmActionBtn = document.getElementById("confirm-action-btn");
    
    // Export functions that need to be called from the global scope script block
    window.renderPlayerChecklist = renderPlayerChecklist;
    window.moduleOpenEditModal = moduleOpenEditModal;
    window.moduleConfirmDeleteSession = moduleConfirmDeleteSession;
    window.moduleDeleteSessionFromEdit = moduleDeleteSessionFromEdit;
    window.moduleSaveEditedSession = saveEditedSession;


    // --- FIREBASE INITIALIZATION & AUTH ---

    async function initFirebase() {
      try {
        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        // Sign in logic using the provided custom token or anonymously
        if (initialAuthToken) {
          await signInWithCustomToken(auth, initialAuthToken);
        } else {
          await signInAnonymously(auth);
        }

        // Wait for the auth state to be established
        onAuthStateChanged(auth, (user) => {
          if (user) {
            userId = user.uid;
          } else {
            // Fallback for userId if anonymous sign-in failed (shouldn't happen)
            userId = crypto.randomUUID();
          }
          document.getElementById("user-id").textContent = userId;
          isAuthReady = true;
          loadData(); // Start loading data only after auth is ready
        });
      } catch (error) {
        console.error("Firebase initialization or authentication failed:", error);
        document.getElementById("status-message").textContent = "Error: Failed to initialize application services.";
      }
    }

    // --- FIRESTORE OPERATIONS ---

    function getSessionDocRef() {
        if (!db || !userId) return null;
        // Private data path: /artifacts/{appId}/users/{userId}/data/userSessions
        const sessionsCollectionPath = `/artifacts/${appId}/users/${userId}/data`;
        return doc(db, sessionsCollectionPath, "userSessions");
    }

    // Load data using real-time listener (onSnapshot)
    function loadData() {
        if (!isAuthReady || !db || !userId) {
            console.log("Waiting for auth to be ready...");
            return;
        }

        const docRef = getSessionDocRef();
        if (!docRef) return;

        document.getElementById("status-message").textContent = "Syncing data from Firestore...";
        
        // Listen for real-time changes
        onSnapshot(docRef, (docSnap) => {
            if (docSnap.exists() && docSnap.data().sessions) {
                // Assuming data is stored as { sessions: [ ... ] }
                sessions = docSnap.data().sessions.map(s => {
                    // Ensure numeric types are restored correctly (though Firestore handles numbers)
                    return {
                        ...s,
                        courtCost: parseFloat(s.courtCost),
                        shuttleCost: parseFloat(s.shuttleCost),
                        shuttlesUsed: parseInt(s.shuttlesUsed, 10),
                        total: parseFloat(s.total),
                        perPlayer: parseFloat(s.perPlayer)
                    };
                });
                console.log("Data loaded/synced from Firestore.");
            } else {
                sessions = [];
                console.log("No existing sessions found in Firestore. Starting fresh.");
            }
            // Always run the rendering functions after data sync
            renderHistory();
            renderMonthOptions();
            updateMonthlyTable();
            document.getElementById("status-message").textContent = "Data Synced.";
        }, (error) => {
            console.error("Error fetching data from Firestore:", error);
            document.getElementById("status-message").textContent = "Error: Failed to sync data from Firestore. Check console for details.";
        });
    }

    // Save data to Firestore (overwrites the whole sessions document)
    async function saveData() {
        if (!isAuthReady || !db || !userId) {
            console.error("Cannot save data: Auth not ready or DB/UserID missing.");
            return;
        }

        const docRef = getSessionDocRef();
        if (!docRef) return;
        
        try {
            // Save the entire array of sessions in a single document
            await setDoc(docRef, { sessions: sessions });
            console.log("Sessions saved to Firestore successfully.");
            document.getElementById("status-message").textContent = "Changes Saved.";
        } catch (error) {
            console.error("Error saving data to Firestore:", error);
            document.getElementById("status-message").textContent = "Error: Failed to save changes to Firestore.";
        }
    }


    // --- APPLICATION LOGIC ---

    function renderPlayerChecklist(containerId, sessionPlayers = []) {
      const container = document.getElementById(containerId);
      container.innerHTML = "";
      allPlayers.forEach(player => {
        const checked = sessionPlayers.includes(player) ? "checked" : "";
        const html = `
          <div style="display: flex; align-items: center;">
            <input type="checkbox" id="${containerId}-${player.replace(/\s/g, '')}" name="player" value="${player}" ${checked} style="margin-right: 8px;">
            <label for="${containerId}-${player.replace(/\s/g, '')}" style="margin-bottom: 0; font-weight: normal;">${player}</label>
          </div>
        `;
        container.insertAdjacentHTML('beforeend', html);
      });
    }

    function calculateMonthlySummary(monthKey) {
      // If monthKey is an empty string, show all sessions
      const filteredSessions = monthKey 
        ? sessions.filter(s => s.monthKey === monthKey) 
        : sessions;
        
      const summary = {};

      filteredSessions.forEach(session => {
        session.players.forEach(player => {
          if (!summary[player]) {
            summary[player] = {
              sessionsCount: 0,
              totalCost: 0
            };
          }
          summary[player].sessionsCount += 1;
          summary[player].totalCost += session.perPlayer;
        });
      });

      // Calculate averages and format
      const formattedSummary = Object.keys(summary).map(player => {
        const data = summary[player];
        return {
          player: player,
          sessionsCount: data.sessionsCount,
          totalCost: data.totalCost.toFixed(2),
          averageCost: (data.totalCost / data.sessionsCount).toFixed(2)
        };
      }).sort((a, b) => parseFloat(b.totalCost) - parseFloat(a.totalCost)); // Sort by total cost descending

      return formattedSummary;
    }

    function renderMonthOptions() {
      const monthKeys = [...new Set(sessions.map(s => s.monthKey))].sort().reverse();
      const selector = document.getElementById("month-selector");
      
      // Determine the month to select: either the current one or the latest one with data
      let defaultSelectedKey = new Date().toISOString().slice(0, 7);
      if (monthKeys.length > 0 && !monthKeys.includes(defaultSelectedKey)) {
          defaultSelectedKey = monthKeys[0]; // Select the latest month with data
      }

      let optionsHTML = `<option value="">All Months</option>`;

      monthKeys.forEach(key => {
        const date = new Date(key + "-01");
        // Ensure month names are correctly formatted
        const monthName = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
        const selected = key === defaultSelectedKey ? "selected" : "";
        optionsHTML += `<option value="${key}" ${selected}>${monthName}</option>`;
      });

      selector.innerHTML = optionsHTML;

      // Re-run the table update based on the possibly new selection
      updateMonthlyTable();
    }

    window.updateMonthlyTable = function() {
      const monthKey = document.getElementById("month-selector").value;
      const tableBody = document.querySelector("#monthly-table tbody");
      tableBody.innerHTML = "";

      const summaryData = calculateMonthlySummary(monthKey);
      let grandTotalCost = 0;
      let grandTotalSessions = 0;

      if (summaryData.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--muted);">No sessions recorded for this month.</td></tr>';
        return;
      }

      summaryData.forEach(data => {
        grandTotalCost += parseFloat(data.totalCost);
        grandTotalSessions += data.sessionsCount;

        const row = `
          <tr>
            <td>${data.player}</td>
            <td>${data.sessionsCount}</td>
            <td>$${data.totalCost}</td>
            <td>$${data.averageCost}</td>
          </tr>
        `;
        tableBody.insertAdjacentHTML('beforeend', row);
      });

      // Add total row
      const totalRow = `
        <tr class="total-row">
          <td>TOTAL</td>
          <td>${grandTotalSessions}</td>
          <td>$${grandTotalCost.toFixed(2)}</td>
          <td>-</td>
        </tr>
      `;
      tableBody.insertAdjacentHTML('beforeend', totalRow);
    }

    function renderHistory() {
      const historyContainer = document.getElementById("sessions-history");
      historyContainer.innerHTML = "";
      document.getElementById("history-count").textContent = sessions.length;

      if (sessions.length === 0) {
         historyContainer.innerHTML = '<p style="text-align: center; color: var(--muted); padding: 20px;">No sessions recorded yet. Add one above!</p>';
         return;
      }

      // Sort by date descending
      const sortedSessions = [...sessions].sort((a, b) => new Date(b.date) - new Date(a.date));

      sortedSessions.forEach(session => {
        const html = `
          <div class="session-item">
            <div class="session-details">
              <p class="session-date">${session.date}</p>
              <p class="session-cost">Total Cost: S$${session.total.toFixed(2)} | Cost per Player: S$${session.perPlayer.toFixed(2)}</p>
              <p class="player-list">Players: ${session.players.join(', ')}</p>
            </div>
            <div class="session-actions">
              <button class="btn btn-secondary btn-sm" onclick="openEditModal('${session.id}')">Edit</button>
              <button class="btn btn-danger btn-sm" onclick="confirmDeleteSession('${session.id}')">Delete</button>
            </div>
          </div>
        `;
        historyContainer.insertAdjacentHTML('beforeend', html);
      });
    }

    // --- MODAL AND FORM FUNCTIONS (Module Scope) ---

    // Add Session Logic (called by global openAddModal -> form submission)
    document.getElementById("addForm").addEventListener("submit", (e) => {
      e.preventDefault();
      addNewSession();
    });

    function addNewSession() {
      const err = document.getElementById("add-err");
      err.style.display = "none";

      const date = document.getElementById("date").value;
      const courtCost = parseFloat(document.getElementById("courtCost").value);
      const shuttleCost = parseFloat(document.getElementById("shuttleCost").value);
      const shuttlesUsed = parseInt(document.getElementById("shuttlesUsed").value, 10);

      const selectedPlayers = [];
      const checkboxes = document.querySelectorAll("#playerChecklist input[name='player']");
      checkboxes.forEach(cb => { if (cb.checked) selectedPlayers.push(cb.value); });

      if (!date || isNaN(courtCost) || isNaN(shuttleCost) || isNaN(shuttlesUsed) || selectedPlayers.length === 0) {
        err.style.display = "block";
        return;
      }

      const total = courtCost + shuttleCost * shuttlesUsed;
      const perPlayer = total / selectedPlayers.length;

      const newSession = {
        id: Date.now().toString(), // Use string ID for Firestore key compatibility
        date: date,
        monthKey: date.slice(0, 7),
        courtCost: courtCost,
        shuttleCost: shuttleCost,
        shuttlesUsed: shuttlesUsed,
        total: total,
        perPlayer: perPlayer,
        players: selectedPlayers,
      };

      sessions.push(newSession);
      saveData();
      window.closeAddModal(); // Call global function
    }

    // Edit Modal (called by global openEditModal)
    function moduleOpenEditModal(id) {
      const session = sessions.find(s => s.id === id);
      if (!session) return;
      if (!window.requireAdmin()) return; // Call global function

      document.getElementById("editSessionId").value = session.id;
      document.getElementById("editDate").value = session.date;
      document.getElementById("editCourtCost").value = session.courtCost;
      document.getElementById("editShuttleCost").value = session.shuttleCost;
      document.getElementById("editShuttlesUsed").value = session.shuttlesUsed;

      renderPlayerChecklist("editPlayerChecklist", session.players);

      document.getElementById("edit-err").style.display = "none";
      editModal.style.display = "flex";
    }

    // Save Edited Session (called by global saveEditedSession)
    function saveEditedSession() {
      const sessionId = document.getElementById("editSessionId").value;
      const sessionIndex = sessions.findIndex(s => s.id === sessionId);
      if (sessionIndex === -1) return;

      const err = document.getElementById("edit-err");
      err.style.display = "none";

      const date = document.getElementById("editDate").value;
      const courtCost = parseFloat(document.getElementById("editCourtCost").value);
      const shuttleCost = parseFloat(document.getElementById("editShuttleCost").value);
      const shuttlesUsed = parseInt(document.getElementById("editShuttlesUsed").value, 10);

      const selectedPlayers = [];
      const checkboxes = document.querySelectorAll("#editPlayerChecklist input[name='player']");
      checkboxes.forEach(cb => { if (cb.checked) selectedPlayers.push(cb.value); });

      if (!date || isNaN(courtCost) || isNaN(shuttleCost) || isNaN(shuttlesUsed) || selectedPlayers.length === 0) {
        err.style.display = "block";
        return;
      }

      const total = courtCost + shuttleCost * shuttlesUsed;
      const perPlayer = total / selectedPlayers.length;

      sessions[sessionIndex] = {
        id: sessionId,
        date: date,
        monthKey: date.slice(0, 7),
        courtCost: courtCost,
        shuttleCost: shuttleCost,
        shuttlesUsed: shuttlesUsed,
        total: total,
        perPlayer: perPlayer,
        players: selectedPlayers,
      };

      saveData();
      window.closeEditModal(); // Call global function
    }

    // Confirmation Modal Implementation (Module Logic)
    function openConfirmModal(title, message, action) {
      document.getElementById("confirm-title").textContent = title;
      document.getElementById("confirm-message").textContent = message;
      // Set the pending action and ensure the button triggers it
      confirmActionBtn.onclick = () => {
        action();
        window.closeConfirmModal(); // Call global function
      };
      confirmModal.style.display = "flex";
    }

    // Function called by the global confirmDeleteSession
    function moduleConfirmDeleteSession(id) {
        openConfirmModal(
            "Delete Session",
            "Are you sure you want to permanently delete this session record?",
            () => deleteSession(id)
        );
    }
    
    // Function called by the global deleteSessionFromEdit
    function moduleDeleteSessionFromEdit() {
        const id = document.getElementById("editSessionId").value;
        window.closeEditModal(); // Call global function
        // Since admin check already passed to open edit modal, we can directly show confirm
        openConfirmModal(
            "Delete Session",
            "Are you sure you want to permanently delete this session record?",
            () => deleteSession(id)
        );
    }

    function deleteSession(id) {
      sessions = sessions.filter(s => s.id !== id);
      saveData();
      // Rendering functions are automatically called by the onSnapshot listener after saveData
    }

    // --- INITIALIZATION ---
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("year").textContent = new Date().getFullYear();
      // renderPlayerChecklist("playerChecklist"); // This is now called inside openAddModal
      initFirebase(); // Start Firebase init and data loading
    });

  </script>
</body>
</html>
